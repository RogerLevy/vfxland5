\ =============================================================================
\ REPL-Game Integration
\ =============================================================================
\ Allows the game to run while the VFX Forth IDE remains fully functional.
\
\ Usage:
\   repl-go    - Start game running in REPL mode (IDE stays responsive)
\   repl-stop  - Stop the game loop
\   go         - Original blocking game loop (for release builds)
\
\ How it works:
\   The VFX Forth REPL polls for input via richedit-key?, which calls BusyIdle
\   on every iteration. By hooking our frame code into BusyIdle, the game
\   renders frames while the IDE waits for input.
\
\ Note: Frame timing is controlled by spin, which waits for the frame timer.
\ =============================================================================

\ Save original BusyIdle action
\ Note: action-of is standard ANS Forth; alternatively use ['] BusyIdle >body @
['] BusyIdle >body @ value 'original-busyidle

\ Flag to control REPL game mode
variable repl-game-active

: repl-post ( - )
    frame-timer al_stop_timer 
    going off
    >vfx 
    global as ;

\ REPL-mode frame: like regular frame with proper spin-based pacing
: repl-mode-frame ( - )
    update-delta
    process-input
    process-tick
    system-controls
    display al_flip_display
    spin
    <esc> pressed? if >vfx then
    ;

\ Single frame execution for REPL mode (no throw, catches errors)
: repl-frame ( - )
    sp@ >r
    [: 
        0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 \ protect VFX Forth from stack underflow
        repl-mode-frame 
    ;] catch ?dup if
        \ Error occurred - stop the game and report
        repl-game-active off
        going @ if repl-post then
        cr ." Game error: " .throw cr
    then 
    r> sp! ;

\ BusyIdle hook that runs game frames
: game-busyidle ( - )
    repl-game-active @ if
        going @ if
            repl-frame
        else
            \ Game ended itself (e.g., via system-controls)
            repl-game-active off
            going @ if repl-post then
            cr ." Game stopped." cr
        then
    then
    'original-busyidle execute ;

\ Install our hook (do this once at startup)
: install-repl-game-hook ( - )
    ['] game-busyidle is BusyIdle ;

: repl-game-installed? ( - flag )
    ['] BusyIdle >body @ ['] game-busyidle = ;

\ REPL-mode pre: like regular pre
: repl-pre ( - )
    \ >display
    esc-quits off
    update-delta update-delta
    need-pump on
    going on
    frame-timer al_resume_timer
    spin ;

\ Start game in REPL mode - IDE stays responsive
: repl-go ( - )
    going @ if
        cr ." Game already running." cr exit
    then
    repl-pre                    \ Initialize game state (REPL version)
    repl-game-active on
    cr ." Game started (REPL mode). Type 'repl-stop' to stop." cr ;

\ Stop game from REPL mode
: repl-stop ( - )
    repl-game-active @ 0= if
        cr ." Game not running in REPL mode." cr exit
    then
    repl-game-active off
    going @ if repl-post then
    cr ." Game stopped." cr ;

\ Initialize on load
install-repl-game-hook
cr ." REPL-Game integration loaded." cr
cr ." Use 'repl-go' to start game with IDE responsive." cr

redef : go 
    debug @ if 
        repl-go 
        >display
    else 
        esc-quits on 
        go 
    then ;
