require %idir%/cjson.vfx
require %idir%/nibs-json.vfx

also cjson>>

s" test.json" load-file parse-json value it

: user[] "users" it get-array get-item ;
0 user[] cjson. cr
1 user[] cjson. cr

0 value obj1
0 value obj2

: test-cjson-setters ( - )
    cr ." Testing cJSON setters..." cr
    
    \ Create object and add fields
    new-object to obj1
    "Alice" "name" obj1 add-string
    "Warrior" "class" obj1 add-string
    100 "health" obj1 add-int
    50 "x" obj1 add-int
    25 "y" obj1 add-int
    
    \ Print the JSON
    ." Created object: " obj1 cjson. cr
    
    \ Create second object
    new-object to obj2
    obj1 "nested" obj2 add-object
    "Bob" "name" obj2 add-string
    75 "mana" obj2 add-int
    
    \ Test floats
    3.14159e0 "pi" obj2 add-float
    98.6e0 "temperature" obj2 add-float

    \ Verify reads
    "name" obj2 get-string 
    ." Name field: " type cr
  
    "mana" obj2 get-int
    ." Mana field: " . cr
    
    "pi" obj2 get-float
    ." Pi value: " f. cr
    
    "temperature" obj2 get-float
    ." Temperature: " f. cr
    
    \ Final output
    ." Final object: " obj2 cjson. cr
    
    ." Test complete!" cr ;

test-cjson-setters

: test-cjson-serialize
    s" out.json" serjson>
        >r 
        "test" "foo" r@ add-string
        123 "bar" r@ add-int
        r> drop ;

test-cjson-serialize

class: %actor
    prop x :fixed <save
    prop y :fixed <save
    prop hp :int <save
    template { 5. x ! 10. y ! 15 hp ! }
class;

%actor object actor0

actor0 s" actor.json" save-as-json

3 %actor array scene0

0 scene0 el@ { 1000. rnd 500. - x ! 1000. rnd 500. - y ! 100 rnd hp ! } 
1 scene0 el@ { 1000. rnd 500. - x ! 1000. rnd 500. - y ! 100 rnd hp ! } 
2 scene0 el@ { 1000. rnd 500. - x ! 1000. rnd 500. - y ! 100 rnd hp ! } 

|| 0 value arr 0 value path 0 value len 0 value croot 0 value cjson-arr
also cjson>> \ necessary because of how || works ... TODO: gonna revisit scope.vfx to fix stuff like this

: save-objects ( array path len - )
    to len to path to arr 
    path len serjson> 
        to croot
        new-array to cjson-arr
        arr #items for
            i arr el@ *json 0 cjson-arr add-object
        loop 
        cjson-arr "actors" croot add-array ;

scene0 s" scene.json" save-objects

100 %addr stack teststack

: one  make dup teststack push ;
    
: read-actors ( path len - )
    {: path path-len | croot cobj buf buf-len :}
    path path-len load-json to croot
    croot "actors" jcount for
        dup i j@ to cobj
        cobj "class" @string evaluate one cobj swap read-props
    loop  drop ;

s" scene.json" read-actors

['] o. teststack each